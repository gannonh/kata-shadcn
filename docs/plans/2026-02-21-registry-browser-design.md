# Registry Browser + Auth Design

**Updated:** Incorporates ownership model — source files tracked in git, custom build regenerates `public/r/`.

## Problem

The registry at shadcn-registry-eight.vercel.app currently:
- Shows template boilerplate on the homepage (not our components)
- Is publicly accessible with no auth (anyone can fetch component source)
- Has 1409 components as downloaded JSON blobs in `public/r/` — not editable, not version-controlled as source
- Has no way to browse components

## Goals

1. Extract source code from the downloaded JSON blobs into tracked source files in `registry/`
2. Build a custom build script that regenerates `public/r/` from those source files
3. Protect `/r/*` routes with a shared secret token
4. Replace the homepage with a searchable component browser

## Source Ownership Model

```
registry/
  blocks/
    about1/
      about1.tsx       ← owned, version controlled, editable
    hero1/
      hero1.tsx
  components/
    shared/
      logo.tsx         ← shared helpers, deduplicated
registry.json          ← manifest, version controlled
public/r/              ← GENERATED output, gitignored
scripts/
  extract-sources.ts   ← one-time migration from downloaded JSONs
  build-registry.ts    ← regenerates public/r/ from registry/
```

Workflow for modifying a component:
1. Edit `registry/blocks/hero1/hero1.tsx`
2. Run `pnpm registry:build`
3. Deploy

## Auth Middleware

**File:** `middleware.ts` in the registry root

- Intercepts all requests matching `/r/:path*`
- Checks for `x-registry-token` header matching `process.env.REGISTRY_TOKEN`
- Returns 401 JSON if missing or invalid
- Passes through all other routes (homepage, assets)

**Consuming project setup:**
```json
// components.json
{
  "registries": {
    "@ourorg": {
      "url": "https://shadcn-registry-eight.vercel.app/r/{name}",
      "headers": {
        "x-registry-token": "${REGISTRY_TOKEN}"
      }
    }
  }
}
```
Each project adds `REGISTRY_TOKEN=<secret>` to `.env`.
The secret is set in Vercel project env vars.

## Component Browser

### Data

`scripts/build-registry.ts` also generates `lib/component-index.json` alongside `public/r/`:
```json
[
  {
    "name": "hero1",
    "title": "Hero",
    "description": "...",
    "category": "hero",
    "installCommand": "npx shadcn add @ourorg/hero1"
  }
]
```
Category = everything before the first digit in the name.

### Page (`app/page.tsx`)

Client component. Static import of `component-index.json` (baked into build). React state for search/filter.

Layout: search bar → category filter chips → component card grid.

**Card:** name, category badge, description, copy-to-clipboard install command, link for visual preview (placeholder until milestone 3).

## Files

- `scripts/extract-sources.ts` — one-time migration
- `scripts/build-registry.ts` — replaces `shadcn build`
- `registry/blocks/` — extracted source files
- `registry/components/` — extracted shared helpers
- `registry.json` — updated manifest pointing to `registry/` paths
- `lib/component-index.json` — browser index (gitignored, generated)
- `public/r/` — gitignored (generated by build script)
- `middleware.ts` — auth
- `.env.example` — documents REGISTRY_TOKEN
- `app/page.tsx` — replaced with browser
